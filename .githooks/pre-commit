#!/bin/sh
# Pre-commit hook to format Lua files with stylua

# Find stylua - check common locations
STYLUA=""
if command -v stylua >/dev/null 2>&1; then
    STYLUA="stylua"
elif [ -x "$HOME/.cargo/bin/stylua" ]; then
    STYLUA="$HOME/.cargo/bin/stylua"
else
    echo "stylua is not installed. Please install it first."
    echo "  cargo install stylua"
    exit 1
fi

# Format all Lua files
echo "Formatting Lua files with stylua..."
$STYLUA .

# Check if any files were modified
if [ -n "$(git diff --name-only)" ]; then
    echo "Files were formatted. Adding changes to commit..."
    git add -u
fi

# Run tests to ensure nothing broke
echo "Running tests..."
if ! make test > /dev/null 2>&1; then
    echo "Tests failed! Please fix the issues before committing."
    exit 1
fi

echo "Pre-commit checks passed!"
exit 0
